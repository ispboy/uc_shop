<?php/** * uc_shop_switch */function uc_shop_switch() {  drupal_set_title('请选择地区分店进行购物');  $dict = array();  $sql = "SELECT DISTINCT `field_address_province` AS `key`,`region_name` AS `val`          FROM {content_type_shop} shop INNER JOIN {china_address} addr          ON addr.region_id=shop.field_address_province          UNION          SELECT DISTINCT `field_address_city` AS `key`,`region_name` AS `val`          FROM {content_type_shop} shop INNER JOIN {china_address} addr          ON addr.region_id=shop.field_address_city  ";  $result = db_query($sql);  while ($row = db_fetch_object($result)) {    $dict[$row->key] = $row->val;  }  $items = array();  $sql = "SELECT n.nid, n.title, s.field_address_province, s.field_address_city,    s.field_domain_id_value, dm.subdomain, dm.scheme, dm.valid    FROM {content_type_shop} s INNER JOIN {node} n    ON s.vid=n.vid LEFT JOIN {domain} dm ON s.field_domain_id_value= dm.domain_id    ORDER BY `field_address_province`,`field_address_city`";  $result = db_query($sql);  while ($row = db_fetch_object($result)) {    $nid = $row->nid;    $title = $row->title;    $province = $row->field_address_province;    $city = $row->field_address_city;    $items[$dict[$province]][$dict[$city]][$nid] = array(      'title' => $title,      'domain_id' => $row->field_domain_id_value,      'subdomain' => $row->subdomain,      'scheme' => $row->scheme,      'valid' => $row->valid,    );  }  $output = '<div class="compact"><dl>';  foreach ($items as $province=>$cities) {    $output .= '<dt>'. $province. '</dt>';    $output .= '<dd>';    foreach ($cities as $city=>$shops) {      $output .= '<dl class="clear-block"><dt>'. $city. '</dt>';      $output .= '<dd>';      foreach ($shops as $nid=>$data) {        if ($data['domain_id'] && $data['valid']) {          $output .= l($data['title'], $data['scheme']. '://'. $data['subdomain'], array('external' => TRUE, 'attributes'=> array('class' => 'title')));        } else {          // $output .= l($data['title'], 'node/'. $nid);          $output .= '<span class="title">'. $data['title']. '</span>';        }      }      $output .= '</dd>';      $output .= '</dl>';    }    $output .= '</dd>';  }  $output .= '</dl></div>';  //dpm($items);  return $output;}